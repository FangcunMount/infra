# 服务器初始化 - 网络环境配置

> 🌐 配置VPN代理、网络优化和防火墙安全策略

## 🎯 网络配置目标

- 配置智能VPN代理（mihomo/clash）
- 优化网络连接性能
- 设置防火墙安全规则
- 配置域名解析和路由规则
- 建立网络监控和诊断

## 🌐 网络架构设计

### 网络层次结构

```
🌍 Internet
    │
┌───▼────────────────────────────────────────┐
│              VPN 代理层                     │
│  ┌─────────────────────────────────────────┐│
│  │     mihomo (clash core)                ││
│  │  • 智能分流规则                         ││
│  │  • 负载均衡                            ││
│  │  • 故障转移                            ││
│  └─────────────────────────────────────────┘│
└────────────────────────────────────────────┘
    │
┌───▼────────────────────────────────────────┐
│              防火墙层                       │
│  ┌─────────────────────────────────────────┐│
│  │           UFW/iptables                 ││
│  │  • 端口访问控制                        ││
│  │  • IP 白名单                           ││
│  │  • DDoS 防护                           ││
│  └─────────────────────────────────────────┘│
└────────────────────────────────────────────┘
    │
┌───▼────────────────────────────────────────┐
│             Docker 网络层                   │
│  ┌─────────────────────────────────────────┐│
│  │      infra-frontend (对外)             ││
│  │      infra-backend (内部)              ││
│  └─────────────────────────────────────────┘│
└────────────────────────────────────────────┘
```

## 🚀 自动化安装

### 一键网络环境配置

```bash
# 执行网络环境配置脚本
sudo ./scripts/init-server/setup-network.sh

# 脚本会自动完成：
# ✅ 安装 mihomo (clash core)
# ✅ 配置智能分流规则
# ✅ 设置防火墙规则
# ✅ 优化网络参数
# ✅ 配置系统代理
```

### 网络诊断和修复

```bash
# 网络连接诊断
sudo ./scripts/init-server/diagnose-network.sh

# 自动检测和修复：
# 🔍 DNS解析测试
# 🔍 代理连接测试  
# 🔍 防火墙规则检查
# 🔍 网络延迟测试
# 🛠️ 自动修复常见问题
```

## 🔧 手动配置步骤

### 步骤 1: 安装 mihomo 代理

```bash
# 下载 mihomo 二进制文件（已包含在 static/ 目录）
sudo cp static/mihomo-linux-amd64 /usr/local/bin/mihomo
sudo chmod +x /usr/local/bin/mihomo

# 创建配置目录
sudo mkdir -p /etc/mihomo
sudo mkdir -p /var/log/mihomo

# 创建用户和组
sudo useradd -r -s /bin/false -d /etc/mihomo mihomo
sudo chown -R mihomo:mihomo /etc/mihomo /var/log/mihomo
```

### 步骤 2: 配置 mihomo 服务

```bash
# 创建 systemd 服务文件
sudo tee /etc/systemd/system/mihomo.service << 'EOF'
[Unit]
Description=Mihomo Service
After=network.target

[Service]
Type=simple
User=mihomo
Group=mihomo
ExecStart=/usr/local/bin/mihomo -d /etc/mihomo
ExecReload=/bin/kill -HUP $MAINPID
Restart=on-failure
RestartSec=5
LimitNOFILE=1048576

[Install]
WantedBy=multi-user.target
EOF

# 重新加载 systemd 配置
sudo systemctl daemon-reload
```

### 步骤 3: 配置代理规则

```bash
# 创建基础配置文件
sudo tee /etc/mihomo/config.yaml << 'EOF'
# 基础配置
port: 7890
socks-port: 7891
redir-port: 7892
mixed-port: 7893
allow-lan: false
bind-address: '*'
mode: rule
log-level: info
ipv6: true

# DNS配置
dns:
  enable: true
  ipv6: false
  listen: 0.0.0.0:53
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16
  nameserver:
    - 223.5.5.5
    - 119.29.29.29
    - 8.8.8.8
  fallback:
    - 8.8.8.8
    - 1.1.1.1

# 代理组配置（需要根据实际订阅修改）
proxy-groups:
  - name: "🚀 节点选择"
    type: select
    proxies:
      - "♻️ 自动选择"
      - "🎯 全球直连"
  
  - name: "♻️ 自动选择"
    type: url-test
    proxies: []
    url: 'http://www.gstatic.com/generate_204'
    interval: 300

  - name: "🎯 全球直连"
    type: select
    proxies:
      - DIRECT

# 分流规则
rule-providers:
  geosite:
    type: http
    behavior: domain
    url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/gfw.txt"
    path: ./geosite.yaml
    interval: 86400

  geoip:
    type: http
    behavior: ipcidr
    url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/cncidr.txt"
    path: ./geoip.yaml
    interval: 86400

# 规则配置
rules:
  - GEOSITE,category-ads-all,REJECT
  - GEOSITE,gfw,🚀 节点选择
  - GEOIP,CN,🎯 全球直连
  - MATCH,🚀 节点选择
EOF

# 复制静态规则文件
sudo cp static/geosite.dat /etc/mihomo/
sudo cp static/geoip.metadb /etc/mihomo/
sudo chown -R mihomo:mihomo /etc/mihomo
```

### 步骤 4: 配置防火墙规则

```bash
# 重置 UFW 防火墙
sudo ufw --force reset

# 设置默认策略
sudo ufw default deny incoming
sudo ufw default allow outgoing

# 允许基础服务
sudo ufw allow 22/tcp comment 'SSH'
sudo ufw allow 80/tcp comment 'HTTP'  
sudo ufw allow 443/tcp comment 'HTTPS'

# 允许 Docker 服务端口
sudo ufw allow 8080/tcp comment 'Jenkins'
sudo ufw allow from 172.16.0.0/12 comment 'Docker networks'
sudo ufw allow from 10.0.0.0/8 comment 'Private networks'

# 允许本地代理
sudo ufw allow from 127.0.0.1 to any port 7890:7893 comment 'Mihomo proxy'

# 启用防火墙
sudo ufw --force enable

# 显示规则状态
sudo ufw status verbose
```

### 步骤 5: 系统网络优化

```bash
# 创建网络优化配置
sudo tee /etc/sysctl.d/99-network-optimization.conf << 'EOF'
# TCP 性能优化
net.core.rmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_default = 262144
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 65536 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216

# 连接数优化
net.core.somaxconn = 65535
net.ipv4.tcp_max_syn_backlog = 65535
net.core.netdev_max_backlog = 5000

# TCP 连接优化
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_syncookies = 1

# 防 DDoS 优化
net.ipv4.tcp_syn_retries = 2
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_max_tw_buckets = 5000

# 文件句柄优化
fs.file-max = 1048576
EOF

# 应用优化配置
sudo sysctl -p /etc/sysctl.d/99-network-optimization.conf
```

### 步骤 6: 配置系统代理

```bash
# 创建代理配置脚本
sudo tee /usr/local/bin/proxy-control << 'EOF'
#!/bin/bash

PROXY_HOST="127.0.0.1"
PROXY_PORT="7890"
PROXY_URL="http://${PROXY_HOST}:${PROXY_PORT}"

case "$1" in
    start|enable)
        export http_proxy="$PROXY_URL"
        export https_proxy="$PROXY_URL"
        export HTTP_PROXY="$PROXY_URL"
        export HTTPS_PROXY="$PROXY_URL"
        export no_proxy="localhost,127.0.0.1,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
        export NO_PROXY="$no_proxy"
        echo "✅ 系统代理已启用: $PROXY_URL"
        ;;
    stop|disable)
        unset http_proxy https_proxy HTTP_PROXY HTTPS_PROXY no_proxy NO_PROXY
        echo "❌ 系统代理已禁用"
        ;;
    status)
        if [ -n "$http_proxy" ]; then
            echo "✅ 代理状态: 已启用 ($http_proxy)"
        else
            echo "❌ 代理状态: 已禁用"
        fi
        ;;
    *)
        echo "使用方法: $0 {start|stop|status|enable|disable}"
        exit 1
        ;;
esac
EOF

sudo chmod +x /usr/local/bin/proxy-control
```

## 📊 服务管理命令

### mihomo 服务控制

```bash
# 启动服务
sudo systemctl start mihomo
sudo systemctl enable mihomo

# 查看状态
sudo systemctl status mihomo

# 查看日志
sudo journalctl -u mihomo -f

# 重启服务
sudo systemctl restart mihomo

# 停止服务
sudo systemctl stop mihomo
```

### 代理管理别名

```bash
# 添加到用户 .bashrc
cat >> ~/.bashrc << 'EOF'
# 代理管理别名
alias proxy-on='source /usr/local/bin/proxy-control start'
alias proxy-off='source /usr/local/bin/proxy-control stop'
alias proxy-status='/usr/local/bin/proxy-control status'

# mihomo 管理别名
alias mihomo-start='sudo systemctl start mihomo'
alias mihomo-stop='sudo systemctl stop mihomo'
alias mihomo-restart='sudo systemctl restart mihomo'
alias mihomo-status='sudo systemctl status mihomo'
alias mihomo-logs='sudo journalctl -u mihomo -f'
EOF

source ~/.bashrc
```

## 🔍 网络测试和验证

### 基础连通性测试

```bash
# 测试 DNS 解析
nslookup google.com
dig @8.8.8.8 google.com

# 测试 HTTP 连接
curl -I http://www.google.com
wget --spider http://www.github.com

# 测试代理连接
curl --proxy http://127.0.0.1:7890 -I http://www.google.com

# 测试网络延迟
ping -c 4 8.8.8.8
traceroute 8.8.8.8
```

### 代理功能验证

```bash
# 检查代理监听端口
sudo netstat -tulpn | grep mihomo
sudo ss -tulpn | grep 789

# 测试代理 API
curl http://127.0.0.1:9090/proxies

# 检查规则匹配
curl "http://127.0.0.1:9090/rules"

# 查看连接统计
curl "http://127.0.0.1:9090/connections"
```

### 防火墙状态检查

```bash
# 查看防火墙状态
sudo ufw status verbose

# 查看 iptables 规则
sudo iptables -L -n -v

# 测试端口开放
sudo nmap -sT -O localhost
nc -zv localhost 80
```

## 📋 验证检查清单

### ✅ 代理服务验证

```bash
# 检查 mihomo 进程
pgrep -f mihomo && echo "✅ mihomo 进程运行中" || echo "❌ mihomo 进程未运行"

# 检查监听端口
ss -tulpn | grep :7890 && echo "✅ 代理端口正常监听" || echo "❌ 代理端口未监听"

# 测试代理连接
curl --connect-timeout 10 --proxy http://127.0.0.1:7890 -I http://www.google.com >/dev/null 2>&1 && echo "✅ 代理连接正常" || echo "❌ 代理连接失败"
```

### ✅ 防火墙配置验证

```bash
# 检查防火墙状态
sudo ufw status | grep -q "Status: active" && echo "✅ 防火墙已启用" || echo "❌ 防火墙未启用"

# 检查关键端口
sudo ufw status | grep -q "22/tcp" && echo "✅ SSH 端口已开放" || echo "❌ SSH 端口未开放"
sudo ufw status | grep -q "80/tcp" && echo "✅ HTTP 端口已开放" || echo "❌ HTTP 端口未开放"
sudo ufw status | grep -q "443/tcp" && echo "✅ HTTPS 端口已开放" || echo "❌ HTTPS 端口未开放"
```

### ✅ 网络优化验证

```bash
# 检查系统参数
sysctl net.core.somaxconn | grep -q "65535" && echo "✅ 网络参数优化生效" || echo "❌ 网络参数优化未生效"

# 检查文件句柄限制
ulimit -n | awk '$1 >= 1048576 { print "✅ 文件句柄限制合适" } $1 < 1048576 { print "❌ 文件句柄限制过低: " $1 }'
```

## 🚨 故障排除

### 代理连接问题

```bash
# 问题 1: mihomo 启动失败
sudo journalctl -u mihomo --no-pager -l

# 检查配置文件语法
/usr/local/bin/mihomo -t -d /etc/mihomo

# 检查端口占用
sudo lsof -i :7890

# 问题 2: 代理无法访问外网
# 检查订阅链接和节点配置
curl -v http://127.0.0.1:9090/proxies

# 检查 DNS 解析
nslookup www.google.com 127.0.0.1
```

### 防火墙问题

```bash
# 问题 3: 服务无法访问
# 查看被拒绝的连接
sudo tail -f /var/log/ufw.log

# 临时禁用防火墙测试
sudo ufw disable

# 重置防火墙规则
sudo ufw --force reset
```

### 网络性能问题

```bash
# 问题 4: 网络连接缓慢
# 检查网络延迟
ping -c 10 8.8.8.8

# 检查 DNS 解析速度
time nslookup google.com

# 检查系统负载
htop
iotop
```

## 🔧 高级配置

### 自定义分流规则

```bash
# 编辑自定义规则文件
sudo vim /etc/mihomo/custom-rules.yaml

# 添加自定义域名规则
- DOMAIN-SUFFIX,your-domain.com,🎯 全球直连
- DOMAIN-KEYWORD,api,🚀 节点选择
- IP-CIDR,192.168.0.0/16,🎯 全球直连
```

### 负载均衡配置

```bash
# 配置多节点负载均衡
proxy-groups:
  - name: "⚖️ 负载均衡"
    type: load-balance
    proxies:
      - "节点1"
      - "节点2" 
      - "节点3"
    url: 'http://www.gstatic.com/generate_204'
    interval: 300
    strategy: round-robin
```

### 流量监控

```bash
# 安装网络监控工具
sudo apt update && sudo apt install -y vnstat iftop nethogs

# 启用流量统计
sudo systemctl enable vnstat
sudo systemctl start vnstat

# 查看流量统计
vnstat -l  # 实时流量
vnstat -d  # 日流量统计
vnstat -m  # 月流量统计
```

## 🔄 下一步

网络环境配置完成后，请继续进行：

1. [🐳 Docker 安装配置](服务器初始化--docker.md) - 安装和配置Docker环境
2. [🔧 网络&基础卷](服务器组件--网络&基础卷.md) - 创建Docker网络和存储卷

---

> 💡 **网络安全提醒**:
> - 定期更新代理订阅和规则文件
> - 监控异常网络连接和流量
> - 保持防火墙规则最新和最小化开放
> - 定期检查和更新网络优化参数