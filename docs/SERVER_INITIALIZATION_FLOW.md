# 🚀 新服务器标准初始化流程

## 📋 三步骤初始化流程

### 🎯 执行顺序
```
1. init-users.sh      # 用户和安全配置
2. setup-network.sh   # 网络环境配置
3. install-docker.sh  # Docker 容器环境
```

## 🔍 详细步骤说明

### 第一步：用户初始化
```bash
sudo ./init-users.sh
```

**功能：**
- ✅ 创建系统用户账户
- ✅ 配置 SSH 密钥认证
- ✅ 设置 sudo 权限
- ✅ 安全加固配置
- ✅ 防火墙基础规则

**输出：**
- 用户账户就绪
- SSH 安全访问配置完成
- 基础安全策略生效

---

### 第二步：网络环境配置
```bash
sudo ./setup-network.sh
```

**功能：**
- ✅ 安装 mihomo 二进制文件
- ✅ 配置 VPN 代理服务
- ✅ 处理地理位置数据
- ✅ 设置全局代理环境
- ✅ 创建 systemd 服务

**输出：**
- 网络代理服务运行（端口 7890）
- 管理面板可用（端口 9090）
- 全局网络环境优化
- Docker 安装的网络基础就绪

---

### 第三步：Docker 环境安装
```bash
sudo ./install-docker.sh
```

**功能：**
- ✅ 安装 Docker Engine
- ✅ 配置 Docker 服务
- ✅ 设置用户权限
- ✅ 配置镜像加速（通过步骤2的代理）

**输出：**
- Docker 服务就绪
- 容器化环境可用
- 镜像拉取顺畅（得益于网络代理）

## 🎯 流程优势

### 🔄 **解决依赖关系**
- **步骤1** → 提供安全的执行环境
- **步骤2** → 提供网络代理支持
- **步骤3** → 利用代理安装 Docker

### 📈 **提升成功率**
- ✅ **避免网络问题** - Docker 安装时代理已就绪
- ✅ **避免权限问题** - 用户配置已完成
- ✅ **避免依赖冲突** - 按正确顺序安装

### ⚡ **优化安装体验**
- 🚀 每步独立验证，问题定位精确
- 🚀 支持断点续传，可从任意步骤重新开始
- 🚀 自动环境检测，适配不同网络环境

## 📊 执行时间估算

| 步骤 | 预估时间 | 主要操作 |
|------|---------|---------|
| init-users.sh | 2-5分钟 | 用户创建、SSH配置 |
| setup-network.sh | 3-8分钟 | 网络配置、订阅更新 |
| install-docker.sh | 5-10分钟 | Docker安装、配置 |
| **总计** | **10-23分钟** | **完整环境就绪** |

## 🔧 验证检查

### 每步完成后的验证命令：

#### 步骤1完成后：
```bash
# 检查用户创建
id <username>

# 检查SSH配置
ssh -T git@github.com

# 检查防火墙
sudo ufw status
```

#### 步骤2完成后：
```bash
# 检查网络服务
systemctl status mihomo
mihomo-control status

# 检查代理功能
curl -I --proxy http://localhost:7890 https://www.google.com

# 检查管理面板
curl -s http://localhost:9090/version
```

#### 步骤3完成后：
```bash
# 检查Docker服务
systemctl status docker
docker version

# 检查镜像拉取
docker pull hello-world
docker run hello-world
```

## 🚨 故障处理

### 如果某步失败：
1. **查看日志** - 每个脚本都有详细的错误信息
2. **单独重试** - 可以重新运行失败的步骤
3. **检查依赖** - 确认前置步骤是否正确完成

### 常见问题：
- **网络超时** → 步骤2的代理配置会解决
- **权限不足** → 步骤1的用户配置会解决
- **端口冲突** → 脚本会自动检测并提示

## 🎉 完成标志

全部执行完成后，服务器将具备：

✅ **安全的用户环境** - 密钥认证、权限控制
✅ **优化的网络环境** - 代理加速、DNS优化  
✅ **完整的容器环境** - Docker就绪、镜像加速
✅ **标准化的管理** - 统一的服务管理接口

## 📝 使用建议

1. **按顺序执行** - 不要跳过或调换步骤
2. **验证完成** - 每步完成后运行验证命令
3. **保留日志** - 保存执行输出便于问题排查
4. **文档备份** - 记录关键配置信息（如SSH密钥、VPN订阅等）

这个三步流程已经过优化，能够处理大多数服务器初始化场景！