# ğŸŒ Docker ç½‘ç»œæ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“‹ å½“å‰ç½‘ç»œæ¶æ„åˆ†æ

### ç°çŠ¶æ€»ç»“

ä½ çš„ Docker ç»„ä»¶ç³»ç»Ÿç›®å‰ä½¿ç”¨äº†**åŒå±‚ç½‘ç»œæ¶æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend      â”‚    â”‚    Backend      â”‚
â”‚  (172.19.0.0/16)â”‚    â”‚ (172.20.0.0/16) â”‚
â”‚                 â”‚    â”‚                 â”‚
â”‚  â€¢ Nginx â†â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤ â€¢ MySQL         â”‚
â”‚                 â”‚    â”‚ â€¢ Redis         â”‚
â”‚                 â”‚    â”‚ â€¢ MongoDB       â”‚
â”‚                 â”‚    â”‚ â€¢ Kafka         â”‚
â”‚                 â”‚    â”‚ â€¢ Jenkins       â”‚
â”‚                 â”‚    â”‚ â€¢ ä¸šåŠ¡åº”ç”¨      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®å‘ç°

| ç»„ä»¶ | å½“å‰ç½‘ç»œ | ç«¯å£æš´éœ² | å®‰å…¨é£é™© |
|------|----------|----------|----------|
| **Nginx** | Frontend + Backend | 80/443 | âœ… åˆé€‚ |
| **Jenkins** | Backend | 8080/50000 | âš ï¸ ç›´æ¥æš´éœ² |
| **MySQL** | Backend | - | âœ… å†…éƒ¨è®¿é—® |
| **Redis** | Backend | - | âœ… å†…éƒ¨è®¿é—® |
| **MongoDB** | Backend | - | âœ… å†…éƒ¨è®¿é—® |
| **Kafka** | Backend | - | âœ… å†…éƒ¨è®¿é—® |

## ğŸ¯ ç½‘ç»œå®‰å…¨ä¼˜åŒ–å»ºè®®

### æ ¸å¿ƒé—®é¢˜

1. **Jenkins å®‰å…¨æ€§**ï¼šç›´æ¥æš´éœ² 8080 ç«¯å£ï¼Œç»•è¿‡äº† Nginx çš„å®‰å…¨ä¿æŠ¤
2. **ç½‘ç»œéš”ç¦»ä¸å¤Ÿ**ï¼šBackend ç½‘ç»œ `internal=false`ï¼Œç†è®ºä¸Šå¯ä»¥è®¿é—®å¤–ç½‘
3. **SSL ç»ˆç»“åˆ†æ•£**ï¼šå„æœåŠ¡ç‹¬ç«‹å¤„ç† HTTPSï¼Œç®¡ç†å¤æ‚
4. **è®¿é—®æ§åˆ¶ç¼ºå¤±**ï¼šç¼ºä¹ç»Ÿä¸€çš„è®¿é—®æ§åˆ¶å’Œå®¡è®¡

### ä¼˜åŒ–æ–¹æ¡ˆï¼šä»£ç†åŒ–æ¶æ„

#### ç›®æ ‡æ¶æ„
```
Internet
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Nginx       â”‚  â† ç»Ÿä¸€å…¥å£ï¼ˆSSLç»ˆç»“ã€è®¿é—®æ§åˆ¶ï¼‰
â”‚  Frontendç½‘ç»œ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“ ä»£ç†è½¬å‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Backendç½‘ç»œ   â”‚  â† å®Œå…¨å†…éƒ¨ç½‘ç»œï¼ˆinternal=trueï¼‰
â”‚                 â”‚
â”‚  â€¢ Jenkins:8080 â”‚  â† åªèƒ½é€šè¿‡ä»£ç†è®¿é—®
â”‚  â€¢ MySQL:3306   â”‚
â”‚  â€¢ Redis:6379   â”‚
â”‚  â€¢ MongoDB:27017â”‚
â”‚  â€¢ Kafka:9092   â”‚
â”‚  â€¢ ä¸šåŠ¡åº”ç”¨     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### è®¿é—®è·¯å¾„ä¼˜åŒ–
- **å¤–éƒ¨è®¿é—®**ï¼š`https://jenkins.local` â†’ Nginx â†’ Jenkins:8080
- **æ„å»ºä»£ç†**ï¼š`localhost:50000` â†’ Jenkins:50000ï¼ˆç›´è¿ï¼‰
- **å†…éƒ¨é€šä¿¡**ï¼šæœåŠ¡åè§£æï¼ˆå¦‚ `redis:6379`ï¼‰

## ğŸ›¡ï¸ å®‰å…¨å¢å¼ºæªæ–½

### 1. ç½‘ç»œéš”ç¦»å¢å¼º

```yaml
# ä¼˜åŒ–åçš„ç½‘ç»œé…ç½®
networks:
  frontend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.19.0.0/16
  
  backend:
    driver: bridge
    internal: true  # ğŸ”’ å®Œå…¨å†…éƒ¨ç½‘ç»œ
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

### 2. ä»£ç†é…ç½®ä¼˜åŒ–

```nginx
# Jenkins å®‰å…¨ä»£ç†é…ç½®
server {
    listen 443 ssl http2;
    server_name jenkins.local;
    
    # ğŸ”’ å®‰å…¨å¤´éƒ¨
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-Content-Type-Options nosniff;
    add_header Strict-Transport-Security "max-age=31536000";
    
    location / {
        proxy_pass http://jenkins:8080;
        # å®Œæ•´çš„ä»£ç†é…ç½®...
    }
}
```

### 3. ç«¯å£ç®¡ç†ç­–ç•¥

| æœåŠ¡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | è¯´æ˜ |
|------|--------|--------|------|
| Jenkins Web | `localhost:8080` | `https://jenkins.local` | é€šè¿‡ Nginx ä»£ç† |
| Jenkins Agent | `localhost:50000` | `localhost:50000` | ä¿æŒç›´è¿ï¼ˆæ„å»ºéœ€è¦ï¼‰ |
| å…¶ä»–æœåŠ¡ | å†…éƒ¨è®¿é—® | å†…éƒ¨è®¿é—® | æ— å˜åŒ– |

## ğŸš€ å®æ–½æ­¥éª¤

### å·²å‡†å¤‡çš„ä¼˜åŒ–å·¥å…·

1. **ç½‘ç»œä¼˜åŒ–è„šæœ¬**ï¼š`scripts/utils/optimize-network.sh`
2. **Jenkins ä»£ç†é…ç½®**ï¼š`components/nginx/conf.d/jenkins.conf`
3. **ä¼˜åŒ–åçš„ Jenkins é…ç½®**ï¼š`components/jenkins/override-optimized.yml`

### æ‰§è¡Œä¼˜åŒ–

```bash
# 1. æ£€æŸ¥å½“å‰çŠ¶æ€
./scripts/utils/optimize-network.sh --status

# 2. é¢„è§ˆä¼˜åŒ–æ“ä½œ
./scripts/utils/optimize-network.sh --dry-run

# 3. åˆ›å»ºå¤‡ä»½å¹¶æ‰§è¡Œä¼˜åŒ–
./scripts/utils/optimize-network.sh --backup

# 4. é…ç½®æœ¬åœ°åŸŸåè§£æ
echo "127.0.0.1 jenkins.local" | sudo tee -a /etc/hosts
```

## ğŸ“Š ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

### å®‰å…¨æ€§æå‡

| æ–¹é¢ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| **SSL ç®¡ç†** | åˆ†æ•£åœ¨å„æœåŠ¡ | ç»Ÿä¸€åœ¨ Nginx |
| **è®¿é—®æ§åˆ¶** | æœåŠ¡çº§åˆ« | ç»Ÿä¸€ä»£ç†å±‚ |
| **ç«¯å£æš´éœ²** | å¤šä¸ªç«¯å£ç›´æ¥æš´éœ² | æœ€å°åŒ–æš´éœ² |
| **ç½‘ç»œéš”ç¦»** | åç«¯å¯è®¿é—®å¤–ç½‘ | å®Œå…¨å†…éƒ¨ç½‘ç»œ |
| **æ—¥å¿—å®¡è®¡** | åˆ†æ•£è®°å½• | ç»Ÿä¸€åœ¨ä»£ç†å±‚ |

### ç®¡ç†ä¾¿åˆ©æ€§

| åŠŸèƒ½ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| **è¯ä¹¦ç®¡ç†** | æ¯ä¸ªæœåŠ¡ç‹¬ç«‹ | ç»Ÿä¸€ç®¡ç† |
| **åŸŸåé…ç½®** | IP:ç«¯å£è®¿é—® | å‹å¥½çš„åŸŸå |
| **è´Ÿè½½å‡è¡¡** | ä¸æ”¯æŒ | ä»£ç†å±‚æ”¯æŒ |
| **è®¿é—®æ—¥å¿—** | å„æœåŠ¡åˆ†åˆ« | ç»Ÿä¸€è®°å½• |
| **ç›‘æ§é›†æˆ** | å¤æ‚é…ç½® | æ ‡å‡†åŒ–æ¥å…¥ |

## ğŸ”§ é«˜çº§ç½‘ç»œç‰¹æ€§

### å¯é€‰çš„ä¸‰å±‚ç½‘ç»œæ¶æ„

å¦‚æœä½ éœ€è¦æ›´å¤æ‚çš„ç½‘ç»œéš”ç¦»ï¼Œå¯ä»¥è€ƒè™‘ä¸‰å±‚æ¶æ„ï¼š

```
Management Network â† ç®¡ç†å·¥å…·ï¼ˆJenkinsã€ç›‘æ§ï¼‰
     â†‘
Frontend Network   â† å…¬å¼€è®¿é—®ï¼ˆNginxï¼‰
     â†‘
Backend Network    â† ä¸šåŠ¡æœåŠ¡ï¼ˆæ•°æ®åº“ã€ç¼“å­˜ï¼‰
```

### æœåŠ¡ç½‘æ ¼é›†æˆ

å¯¹äºå¾®æœåŠ¡æ¶æ„ï¼Œå¯ä»¥è€ƒè™‘é›†æˆ Istio æˆ– Linkerdï¼š

```yaml
# æœåŠ¡ç½‘æ ¼æ ‡ç­¾ç¤ºä¾‹
labels:
  - "istio-injection=enabled"
  - "service-mesh.version=1.0"
```

## ğŸ¯ æ¨èé…ç½®

### ç”Ÿäº§ç¯å¢ƒå»ºè®®

1. **ç«‹å³å®æ–½**ï¼š
   - âœ… Jenkins ä»£ç†åŒ–è®¿é—®
   - âœ… Backend ç½‘ç»œå†…éƒ¨åŒ–
   - âœ… SSL è¯ä¹¦ç»Ÿä¸€ç®¡ç†

2. **ä¸­æœŸè§„åˆ’**ï¼š
   - ğŸ”„ é›†æˆå¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨
   - ğŸ”„ å®æ–½ç½‘ç»œç­–ç•¥æ§åˆ¶
   - ğŸ”„ æ·»åŠ  WAF ä¿æŠ¤

3. **é•¿æœŸè€ƒè™‘**ï¼š
   - ğŸ“‹ å¾®æœåŠ¡ç½‘æ ¼
   - ğŸ“‹ é›¶ä¿¡ä»»ç½‘ç»œæ¶æ„
   - ğŸ“‹ å®¹å™¨å®‰å…¨æ‰«æ

### å¼€å‘ç¯å¢ƒé…ç½®

å¯¹äºå¼€å‘ç¯å¢ƒï¼Œå¯ä»¥ä¿æŒç›¸å¯¹å®½æ¾çš„é…ç½®ï¼š

```bash
# å¼€å‘ç¯å¢ƒå¿«é€Ÿè®¿é—®
./scripts/utils/optimize-network.sh --apply-jenkins  # åªä¼˜åŒ– Jenkins
```

## ğŸ’¡ æœ€ä½³å®è·µæ€»ç»“

### ç½‘ç»œè®¾è®¡åŸåˆ™

1. **æœ€å°æƒé™åŸåˆ™**ï¼šæœåŠ¡åªèƒ½è®¿é—®å¿…éœ€çš„ç½‘ç»œå’Œç«¯å£
2. **æ·±åº¦é˜²å¾¡**ï¼šå¤šå±‚å®‰å…¨æ§åˆ¶ï¼Œä¸ä¾èµ–å•ä¸€é˜²æŠ¤ç‚¹
3. **ç»Ÿä¸€ç®¡ç†**ï¼šé›†ä¸­åŒ–çš„é…ç½®å’Œç›‘æ§
4. **å¯è§‚æµ‹æ€§**ï¼šå®Œæ•´çš„æ—¥å¿—å’Œç›‘æ§è¦†ç›–

### è¿ç»´å»ºè®®

1. **å®šæœŸæ£€æŸ¥**ï¼šä½¿ç”¨ `--status` æ£€æŸ¥ç½‘ç»œé…ç½®
2. **é…ç½®å¤‡ä»½**ï¼šé‡è¦å˜æ›´å‰ä½¿ç”¨ `--backup` 
3. **æ¸è¿›éƒ¨ç½²**ï¼šä½¿ç”¨ `--dry-run` é¢„è§ˆå˜æ›´
4. **ç›‘æ§å‘Šè­¦**ï¼šé…ç½®ç½‘ç»œå¼‚å¸¸å‘Šè­¦

è¿™ç§ç½‘ç»œæ¶æ„ä¼˜åŒ–ä¸ä»…æå‡äº†å®‰å…¨æ€§ï¼Œè¿˜ä¸ºåç»­çš„æ‰©å±•å’Œç®¡ç†å¥ å®šäº†è‰¯å¥½çš„åŸºç¡€ã€‚ä½ çš„ç»„ä»¶ç³»ç»Ÿå°†æ›´åŠ å¥å£®å’Œå®‰å…¨ï¼ğŸ›¡ï¸