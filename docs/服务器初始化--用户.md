# 服务器初始化 - 用户环境配置

> 🔧 配置服务器用户权限、SSH 访问和基础安全设置

## 🎯 配置目标

- 创建管理用户和应用用户
- 配置 SSH 密钥认证
- 设置 sudo 权限
- 配置用户环境变量
- 建立基础安全策略

## 👥 用户角色规划

### 系统用户设计

| 用户类型 | 用户名 | 主要职责 | sudo 权限 | SSH 访问 |
|---------|--------|----------|-----------|----------|
| **管理员** | `admin` | 系统管理、部署操作 | ✅ 全部 | ✅ 密钥 |
| **应用用户** | `appuser` | 运行应用服务 | ❌ 无 | ❌ 禁用 |
| **部署用户** | `deploy` | CI/CD 部署 | 🔸 部分 | ✅ 密钥 |
| **监控用户** | `monitor` | 监控数据收集 | ❌ 无 | 🔸 受限 |

### 用户组设计

```bash
# 管理组
wheel           # 系统管理员组
docker          # Docker 操作权限

# 应用组  
appgroup        # 应用服务用户组
deploy          # 部署相关权限
```

## 🚀 自动化安装

### 一键用户初始化

```bash
# 执行用户环境初始化脚本
sudo ./scripts/init-server/init-users.sh

# 脚本会自动完成：
# ✅ 创建所需用户和用户组
# ✅ 配置 SSH 密钥认证  
# ✅ 设置 sudo 权限规则
# ✅ 创建用户工作目录
# ✅ 配置环境变量
```

### 脚本执行流程

```bash
#!/bin/bash
# 执行顺序
1. 检查系统环境和权限
2. 创建用户组 (wheel, docker, appgroup, deploy)
3. 创建系统用户 (admin, appuser, deploy, monitor)  
4. 配置用户主目录和权限
5. 设置 SSH 密钥认证
6. 配置 sudo 权限规则
7. 设置用户环境变量
8. 验证配置正确性
```

## 🔧 手动配置步骤

### 步骤 1: 创建用户组

```bash
# 创建管理组
sudo groupadd wheel 2>/dev/null || true
sudo groupadd docker 2>/dev/null || true

# 创建应用组
sudo groupadd appgroup
sudo groupadd deploy
```

### 步骤 2: 创建用户账号

```bash
# 管理员用户
sudo useradd -m -g wheel -G docker -s /bin/bash admin
sudo passwd admin

# 应用服务用户
sudo useradd -m -g appgroup -s /bin/bash appuser
sudo usermod -L appuser  # 锁定密码登录

# 部署用户
sudo useradd -m -g deploy -G docker -s /bin/bash deploy
sudo passwd deploy

# 监控用户
sudo useradd -m -g appgroup -s /bin/bash monitor
sudo usermod -L monitor  # 锁定密码登录
```

### 步骤 3: 配置 SSH 密钥认证

```bash
# 为管理员用户设置 SSH 密钥
sudo su - admin
mkdir -p ~/.ssh
chmod 700 ~/.ssh

# 添加公钥（替换为您的实际公钥）
cat >> ~/.ssh/authorized_keys << 'EOF'
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAB... your-public-key
EOF

chmod 600 ~/.ssh/authorized_keys
exit

# 为部署用户设置 SSH 密钥
sudo su - deploy
mkdir -p ~/.ssh
chmod 700 ~/.ssh

# 添加 CI/CD 系统的公钥
cat >> ~/.ssh/authorized_keys << 'EOF'
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAB... cicd-public-key
EOF

chmod 600 ~/.ssh/authorized_keys
exit
```

### 步骤 4: 配置 sudo 权限

```bash
# 创建 sudoers 配置文件
sudo tee /etc/sudoers.d/infra-users << 'EOF'
# 管理员用户完全权限
admin ALL=(ALL:ALL) ALL

# 部署用户限制权限
deploy ALL=(ALL:ALL) NOPASSWD: /usr/bin/docker, /usr/local/bin/docker-compose, /bin/systemctl
deploy ALL=(ALL:ALL) NOPASSWD: /usr/bin/make -C /opt/infra/*
deploy ALL=(ALL:ALL) NOPASSWD: /usr/bin/mkdir -p /data/infra*, /usr/bin/chown * /data/infra*, /usr/bin/chmod * /data/infra*

# wheel 组用户权限
%wheel ALL=(ALL:ALL) ALL

# 禁用 root 远程登录
Defaults:ALL !rootpw
EOF

# 验证 sudoers 文件语法
sudo visudo -c -f /etc/sudoers.d/infra-users
```

### 步骤 5: 配置用户环境

```bash
# 配置管理员用户环境
sudo su - admin
cat >> ~/.bashrc << 'EOF'
# Infra 项目环境变量
export INFRA_HOME="/opt/infra"
export COMPOSE_PROJECT_NAME="infra"
export DOCKER_BUILDKIT=1

# 常用别名
alias ll='ls -la'
alias dc='docker-compose'
alias dps='docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"'

# 路径配置
export PATH="$PATH:$INFRA_HOME/scripts"
EOF

# 配置部署用户环境
sudo su - deploy
cat >> ~/.bashrc << 'EOF'
# 部署环境配置
export INFRA_HOME="/opt/infra"
export COMPOSE_PROJECT_NAME="infra"
export DOCKER_BUILDKIT=1

# 部署相关别名
alias deploy-status='make -C $INFRA_HOME status'
alias deploy-logs='make -C $INFRA_HOME logs'
alias deploy-health='make -C $INFRA_HOME health'

# 安全限制 - 只允许在指定目录操作
cd $INFRA_HOME 2>/dev/null || cd /tmp
EOF
```

### 步骤 6: 设置工作目录

```bash
# 创建项目目录
sudo mkdir -p /opt/infra
sudo chown admin:wheel /opt/infra
sudo chmod 755 /opt/infra

# 为部署用户设置访问权限
sudo setfacl -R -m u:deploy:rwx /opt/infra
sudo setfacl -R -d -m u:deploy:rwx /opt/infra

# 创建日志目录
sudo mkdir -p /var/log/infra
sudo chown admin:wheel /var/log/infra
sudo chmod 755 /var/log/infra
```

## 🔒 安全配置

### SSH 安全加固

```bash
# 编辑 SSH 配置
sudo vim /etc/ssh/sshd_config

# 推荐安全配置
Port 22
Protocol 2
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys
MaxAuthTries 3
ClientAliveInterval 300
ClientAliveCountMax 2
```

### 防火墙基础规则

```bash
# 配置基础防火墙规则
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow 22/tcp   # SSH
sudo ufw allow 80/tcp   # HTTP
sudo ufw allow 443/tcp  # HTTPS

# 启用防火墙
sudo ufw --force enable
```

### 文件权限检查

```bash
# 检查关键文件权限
ls -la /etc/sudoers.d/infra-users      # 应该是 440
ls -la ~/.ssh/authorized_keys          # 应该是 600
ls -la ~/.ssh/                         # 应该是 700
```

## 📋 验证检查清单

### ✅ 用户创建验证

```bash
# 检查用户是否创建成功
id admin && echo "✅ admin 用户创建成功" || echo "❌ admin 用户创建失败"
id appuser && echo "✅ appuser 用户创建成功" || echo "❌ appuser 用户创建失败"
id deploy && echo "✅ deploy 用户创建成功" || echo "❌ deploy 用户创建失败"
id monitor && echo "✅ monitor 用户创建成功" || echo "❌ monitor 用户创建失败"

# 检查用户组分配
groups admin | grep -q "wheel docker" && echo "✅ admin 组权限正确" || echo "❌ admin 组权限错误"
groups deploy | grep -q "deploy docker" && echo "✅ deploy 组权限正确" || echo "❌ deploy 组权限错误"
```

### ✅ SSH 访问验证

```bash
# 测试 SSH 密钥登录（从客户端执行）
ssh admin@your-server-ip "echo '✅ admin SSH 访问正常'"
ssh deploy@your-server-ip "echo '✅ deploy SSH 访问正常'"

# 验证密码登录已禁用
ssh -o PreferredAuthentications=password admin@your-server-ip 2>&1 | grep -q "Permission denied" && echo "✅ 密码登录已禁用"
```

### ✅ sudo 权限验证

```bash
# 测试管理员权限
sudo -u admin sudo -l | grep -q "ALL" && echo "✅ admin sudo 权限正确"

# 测试部署用户限制权限
sudo -u deploy sudo -l | grep -q "docker" && echo "✅ deploy docker 权限正确"
sudo -u deploy sudo -l | grep -q "NOPASSWD" && echo "✅ deploy 免密码权限正确"
```

### ✅ 环境变量验证

```bash
# 验证用户环境变量
sudo -u admin bash -c 'echo $INFRA_HOME' | grep -q "/opt/infra" && echo "✅ admin 环境变量正确"
sudo -u deploy bash -c 'echo $COMPOSE_PROJECT_NAME' | grep -q "infra" && echo "✅ deploy 环境变量正确"
```

## 🚨 故障排除

### 常见问题及解决方案

#### 问题 1: SSH 密钥登录失败

```bash
# 检查 SSH 服务状态
sudo systemctl status ssh

# 检查 SSH 配置语法
sudo sshd -t

# 查看 SSH 登录日志
sudo tail -f /var/log/auth.log

# 检查文件权限
ls -la ~/.ssh/
```

#### 问题 2: sudo 权限不生效

```bash
# 检查 sudoers 文件语法
sudo visudo -c

# 检查用户组归属
groups username

# 重启生效
sudo systemctl restart sudo
```

#### 问题 3: 用户环境变量不加载

```bash
# 检查 bashrc 文件
cat ~/.bashrc

# 手动重新加载
source ~/.bashrc

# 检查登录 shell
echo $SHELL
```

## 📊 用户管理维护

### 日常维护命令

```bash
# 查看当前登录用户
who

# 查看用户最后登录时间
lastlog

# 查看用户账户状态
sudo passwd -S username

# 查看失败登录尝试
sudo lastb

# 锁定/解锁用户
sudo usermod -L username  # 锁定
sudo usermod -U username  # 解锁
```

### 定期安全检查

```bash
# 检查 sudo 日志
sudo cat /var/log/auth.log | grep sudo

# 检查 SSH 登录记录
sudo cat /var/log/auth.log | grep ssh

# 检查异常登录
sudo awk '/Failed password/ { print $1, $2, $3, $9, $11 }' /var/log/auth.log
```

## 🔄 下一步

用户环境配置完成后，请继续进行：

1. [🌐 网络环境配置](服务器初始化--网络环境.md) - 配置VPN代理和网络优化
2. [🐳 Docker 安装配置](服务器初始化--docker.md) - 安装和配置Docker环境

---

> 💡 **重要提醒**: 
> - 请妥善保管 SSH 私钥文件
> - 定期轮换用户密码和 SSH 密钥
> - 监控用户登录日志，及时发现异常访问