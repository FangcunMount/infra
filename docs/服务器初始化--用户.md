# æœåŠ¡å™¨åˆå§‹åŒ– - ç”¨æˆ·ç¯å¢ƒé…ç½®

> ğŸ”§ é…ç½®æœåŠ¡å™¨ç”¨æˆ·æƒé™ã€SSH è®¿é—®å’ŒåŸºç¡€å®‰å…¨è®¾ç½®

## ğŸ¯ é…ç½®ç›®æ ‡

- åˆ›å»ºç®¡ç†ç”¨æˆ·å’Œåº”ç”¨ç”¨æˆ·
- é…ç½® SSH å¯†é’¥è®¤è¯
- è®¾ç½® sudo æƒé™
- é…ç½®ç”¨æˆ·ç¯å¢ƒå˜é‡
- å»ºç«‹åŸºç¡€å®‰å…¨ç­–ç•¥

## ğŸ‘¥ ç”¨æˆ·è§’è‰²è§„åˆ’

### ç³»ç»Ÿç”¨æˆ·è®¾è®¡

| ç”¨æˆ·ç±»å‹ | ç”¨æˆ·å | ä¸»è¦èŒè´£ | sudo æƒé™ | SSH è®¿é—® |
|---------|--------|----------|-----------|----------|
| **ç®¡ç†å‘˜** | `admin` | ç³»ç»Ÿç®¡ç†ã€éƒ¨ç½²æ“ä½œ | âœ… å…¨éƒ¨ | âœ… å¯†é’¥ |
| **åº”ç”¨ç”¨æˆ·** | `appuser` | è¿è¡Œåº”ç”¨æœåŠ¡ | âŒ æ—  | âŒ ç¦ç”¨ |
| **éƒ¨ç½²ç”¨æˆ·** | `deploy` | CI/CD éƒ¨ç½² | ğŸ”¸ éƒ¨åˆ† | âœ… å¯†é’¥ |
| **ç›‘æ§ç”¨æˆ·** | `monitor` | ç›‘æ§æ•°æ®æ”¶é›† | âŒ æ—  | ğŸ”¸ å—é™ |

### ç”¨æˆ·ç»„è®¾è®¡

```bash
# ç®¡ç†ç»„
wheel           # ç³»ç»Ÿç®¡ç†å‘˜ç»„
docker          # Docker æ“ä½œæƒé™

# åº”ç”¨ç»„  
appgroup        # åº”ç”¨æœåŠ¡ç”¨æˆ·ç»„
deploy          # éƒ¨ç½²ç›¸å…³æƒé™
```

## ğŸš€ è‡ªåŠ¨åŒ–å®‰è£…

### ä¸€é”®ç”¨æˆ·åˆå§‹åŒ–

```bash
# æ‰§è¡Œç”¨æˆ·ç¯å¢ƒåˆå§‹åŒ–è„šæœ¬
sudo ./scripts/init-server/init-users.sh

# è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆï¼š
# âœ… åˆ›å»ºæ‰€éœ€ç”¨æˆ·å’Œç”¨æˆ·ç»„
# âœ… é…ç½® SSH å¯†é’¥è®¤è¯  
# âœ… è®¾ç½® sudo æƒé™è§„åˆ™
# âœ… åˆ›å»ºç”¨æˆ·å·¥ä½œç›®å½•
# âœ… é…ç½®ç¯å¢ƒå˜é‡
```

### è„šæœ¬æ‰§è¡Œæµç¨‹

```bash
#!/bin/bash
# æ‰§è¡Œé¡ºåº
1. æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒå’Œæƒé™
2. åˆ›å»ºç”¨æˆ·ç»„ (wheel, docker, appgroup, deploy)
3. åˆ›å»ºç³»ç»Ÿç”¨æˆ· (admin, appuser, deploy, monitor)  
4. é…ç½®ç”¨æˆ·ä¸»ç›®å½•å’Œæƒé™
5. è®¾ç½® SSH å¯†é’¥è®¤è¯
6. é…ç½® sudo æƒé™è§„åˆ™
7. è®¾ç½®ç”¨æˆ·ç¯å¢ƒå˜é‡
8. éªŒè¯é…ç½®æ­£ç¡®æ€§
```

## ğŸ”§ æ‰‹åŠ¨é…ç½®æ­¥éª¤

### æ­¥éª¤ 1: åˆ›å»ºç”¨æˆ·ç»„

```bash
# åˆ›å»ºç®¡ç†ç»„
sudo groupadd wheel 2>/dev/null || true
sudo groupadd docker 2>/dev/null || true

# åˆ›å»ºåº”ç”¨ç»„
sudo groupadd appgroup
sudo groupadd deploy
```

### æ­¥éª¤ 2: åˆ›å»ºç”¨æˆ·è´¦å·

```bash
# ç®¡ç†å‘˜ç”¨æˆ·
sudo useradd -m -g wheel -G docker -s /bin/bash admin
sudo passwd admin

# åº”ç”¨æœåŠ¡ç”¨æˆ·
sudo useradd -m -g appgroup -s /bin/bash appuser
sudo usermod -L appuser  # é”å®šå¯†ç ç™»å½•

# éƒ¨ç½²ç”¨æˆ·
sudo useradd -m -g deploy -G docker -s /bin/bash deploy
sudo passwd deploy

# ç›‘æ§ç”¨æˆ·
sudo useradd -m -g appgroup -s /bin/bash monitor
sudo usermod -L monitor  # é”å®šå¯†ç ç™»å½•
```

### æ­¥éª¤ 3: é…ç½® SSH å¯†é’¥è®¤è¯

```bash
# ä¸ºç®¡ç†å‘˜ç”¨æˆ·è®¾ç½® SSH å¯†é’¥
sudo su - admin
mkdir -p ~/.ssh
chmod 700 ~/.ssh

# æ·»åŠ å…¬é’¥ï¼ˆæ›¿æ¢ä¸ºæ‚¨çš„å®é™…å…¬é’¥ï¼‰
cat >> ~/.ssh/authorized_keys << 'EOF'
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAB... your-public-key
EOF

chmod 600 ~/.ssh/authorized_keys
exit

# ä¸ºéƒ¨ç½²ç”¨æˆ·è®¾ç½® SSH å¯†é’¥
sudo su - deploy
mkdir -p ~/.ssh
chmod 700 ~/.ssh

# æ·»åŠ  CI/CD ç³»ç»Ÿçš„å…¬é’¥
cat >> ~/.ssh/authorized_keys << 'EOF'
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAB... cicd-public-key
EOF

chmod 600 ~/.ssh/authorized_keys
exit
```

### æ­¥éª¤ 4: é…ç½® sudo æƒé™

```bash
# åˆ›å»º sudoers é…ç½®æ–‡ä»¶
sudo tee /etc/sudoers.d/infra-users << 'EOF'
# ç®¡ç†å‘˜ç”¨æˆ·å®Œå…¨æƒé™
admin ALL=(ALL:ALL) ALL

# éƒ¨ç½²ç”¨æˆ·é™åˆ¶æƒé™
deploy ALL=(ALL:ALL) NOPASSWD: /usr/bin/docker, /usr/local/bin/docker-compose, /bin/systemctl
deploy ALL=(ALL:ALL) NOPASSWD: /usr/bin/make -C /opt/infra/*
deploy ALL=(ALL:ALL) NOPASSWD: /usr/bin/mkdir -p /data/infra*, /usr/bin/chown * /data/infra*, /usr/bin/chmod * /data/infra*

# wheel ç»„ç”¨æˆ·æƒé™
%wheel ALL=(ALL:ALL) ALL

# ç¦ç”¨ root è¿œç¨‹ç™»å½•
Defaults:ALL !rootpw
EOF

# éªŒè¯ sudoers æ–‡ä»¶è¯­æ³•
sudo visudo -c -f /etc/sudoers.d/infra-users
```

### æ­¥éª¤ 5: é…ç½®ç”¨æˆ·ç¯å¢ƒ

```bash
# é…ç½®ç®¡ç†å‘˜ç”¨æˆ·ç¯å¢ƒ
sudo su - admin
cat >> ~/.bashrc << 'EOF'
# Infra é¡¹ç›®ç¯å¢ƒå˜é‡
export INFRA_HOME="/opt/infra"
export COMPOSE_PROJECT_NAME="infra"
export DOCKER_BUILDKIT=1

# å¸¸ç”¨åˆ«å
alias ll='ls -la'
alias dc='docker-compose'
alias dps='docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"'

# è·¯å¾„é…ç½®
export PATH="$PATH:$INFRA_HOME/scripts"
EOF

# é…ç½®éƒ¨ç½²ç”¨æˆ·ç¯å¢ƒ
sudo su - deploy
cat >> ~/.bashrc << 'EOF'
# éƒ¨ç½²ç¯å¢ƒé…ç½®
export INFRA_HOME="/opt/infra"
export COMPOSE_PROJECT_NAME="infra"
export DOCKER_BUILDKIT=1

# éƒ¨ç½²ç›¸å…³åˆ«å
alias deploy-status='make -C $INFRA_HOME status'
alias deploy-logs='make -C $INFRA_HOME logs'
alias deploy-health='make -C $INFRA_HOME health'

# å®‰å…¨é™åˆ¶ - åªå…è®¸åœ¨æŒ‡å®šç›®å½•æ“ä½œ
cd $INFRA_HOME 2>/dev/null || cd /tmp
EOF
```

### æ­¥éª¤ 6: è®¾ç½®å·¥ä½œç›®å½•

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
sudo mkdir -p /opt/infra
sudo chown admin:wheel /opt/infra
sudo chmod 755 /opt/infra

# ä¸ºéƒ¨ç½²ç”¨æˆ·è®¾ç½®è®¿é—®æƒé™
sudo setfacl -R -m u:deploy:rwx /opt/infra
sudo setfacl -R -d -m u:deploy:rwx /opt/infra

# åˆ›å»ºæ—¥å¿—ç›®å½•
sudo mkdir -p /var/log/infra
sudo chown admin:wheel /var/log/infra
sudo chmod 755 /var/log/infra
```

## ğŸ”’ å®‰å…¨é…ç½®

### SSH å®‰å…¨åŠ å›º

```bash
# ç¼–è¾‘ SSH é…ç½®
sudo vim /etc/ssh/sshd_config

# æ¨èå®‰å…¨é…ç½®
Port 22
Protocol 2
PermitRootLogin no
PasswordAuthentication no
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys
MaxAuthTries 3
ClientAliveInterval 300
ClientAliveCountMax 2
```

### é˜²ç«å¢™åŸºç¡€è§„åˆ™

```bash
# é…ç½®åŸºç¡€é˜²ç«å¢™è§„åˆ™
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow 22/tcp   # SSH
sudo ufw allow 80/tcp   # HTTP
sudo ufw allow 443/tcp  # HTTPS

# å¯ç”¨é˜²ç«å¢™
sudo ufw --force enable
```

### æ–‡ä»¶æƒé™æ£€æŸ¥

```bash
# æ£€æŸ¥å…³é”®æ–‡ä»¶æƒé™
ls -la /etc/sudoers.d/infra-users      # åº”è¯¥æ˜¯ 440
ls -la ~/.ssh/authorized_keys          # åº”è¯¥æ˜¯ 600
ls -la ~/.ssh/                         # åº”è¯¥æ˜¯ 700
```

## ğŸ“‹ éªŒè¯æ£€æŸ¥æ¸…å•

### âœ… ç”¨æˆ·åˆ›å»ºéªŒè¯

```bash
# æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åˆ›å»ºæˆåŠŸ
id admin && echo "âœ… admin ç”¨æˆ·åˆ›å»ºæˆåŠŸ" || echo "âŒ admin ç”¨æˆ·åˆ›å»ºå¤±è´¥"
id appuser && echo "âœ… appuser ç”¨æˆ·åˆ›å»ºæˆåŠŸ" || echo "âŒ appuser ç”¨æˆ·åˆ›å»ºå¤±è´¥"
id deploy && echo "âœ… deploy ç”¨æˆ·åˆ›å»ºæˆåŠŸ" || echo "âŒ deploy ç”¨æˆ·åˆ›å»ºå¤±è´¥"
id monitor && echo "âœ… monitor ç”¨æˆ·åˆ›å»ºæˆåŠŸ" || echo "âŒ monitor ç”¨æˆ·åˆ›å»ºå¤±è´¥"

# æ£€æŸ¥ç”¨æˆ·ç»„åˆ†é…
groups admin | grep -q "wheel docker" && echo "âœ… admin ç»„æƒé™æ­£ç¡®" || echo "âŒ admin ç»„æƒé™é”™è¯¯"
groups deploy | grep -q "deploy docker" && echo "âœ… deploy ç»„æƒé™æ­£ç¡®" || echo "âŒ deploy ç»„æƒé™é”™è¯¯"
```

### âœ… SSH è®¿é—®éªŒè¯

```bash
# æµ‹è¯• SSH å¯†é’¥ç™»å½•ï¼ˆä»å®¢æˆ·ç«¯æ‰§è¡Œï¼‰
ssh admin@your-server-ip "echo 'âœ… admin SSH è®¿é—®æ­£å¸¸'"
ssh deploy@your-server-ip "echo 'âœ… deploy SSH è®¿é—®æ­£å¸¸'"

# éªŒè¯å¯†ç ç™»å½•å·²ç¦ç”¨
ssh -o PreferredAuthentications=password admin@your-server-ip 2>&1 | grep -q "Permission denied" && echo "âœ… å¯†ç ç™»å½•å·²ç¦ç”¨"
```

### âœ… sudo æƒé™éªŒè¯

```bash
# æµ‹è¯•ç®¡ç†å‘˜æƒé™
sudo -u admin sudo -l | grep -q "ALL" && echo "âœ… admin sudo æƒé™æ­£ç¡®"

# æµ‹è¯•éƒ¨ç½²ç”¨æˆ·é™åˆ¶æƒé™
sudo -u deploy sudo -l | grep -q "docker" && echo "âœ… deploy docker æƒé™æ­£ç¡®"
sudo -u deploy sudo -l | grep -q "NOPASSWD" && echo "âœ… deploy å…å¯†ç æƒé™æ­£ç¡®"
```

### âœ… ç¯å¢ƒå˜é‡éªŒè¯

```bash
# éªŒè¯ç”¨æˆ·ç¯å¢ƒå˜é‡
sudo -u admin bash -c 'echo $INFRA_HOME' | grep -q "/opt/infra" && echo "âœ… admin ç¯å¢ƒå˜é‡æ­£ç¡®"
sudo -u deploy bash -c 'echo $COMPOSE_PROJECT_NAME' | grep -q "infra" && echo "âœ… deploy ç¯å¢ƒå˜é‡æ­£ç¡®"
```

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### é—®é¢˜ 1: SSH å¯†é’¥ç™»å½•å¤±è´¥

```bash
# æ£€æŸ¥ SSH æœåŠ¡çŠ¶æ€
sudo systemctl status ssh

# æ£€æŸ¥ SSH é…ç½®è¯­æ³•
sudo sshd -t

# æŸ¥çœ‹ SSH ç™»å½•æ—¥å¿—
sudo tail -f /var/log/auth.log

# æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la ~/.ssh/
```

#### é—®é¢˜ 2: sudo æƒé™ä¸ç”Ÿæ•ˆ

```bash
# æ£€æŸ¥ sudoers æ–‡ä»¶è¯­æ³•
sudo visudo -c

# æ£€æŸ¥ç”¨æˆ·ç»„å½’å±
groups username

# é‡å¯ç”Ÿæ•ˆ
sudo systemctl restart sudo
```

#### é—®é¢˜ 3: ç”¨æˆ·ç¯å¢ƒå˜é‡ä¸åŠ è½½

```bash
# æ£€æŸ¥ bashrc æ–‡ä»¶
cat ~/.bashrc

# æ‰‹åŠ¨é‡æ–°åŠ è½½
source ~/.bashrc

# æ£€æŸ¥ç™»å½• shell
echo $SHELL
```

## ğŸ“Š ç”¨æˆ·ç®¡ç†ç»´æŠ¤

### æ—¥å¸¸ç»´æŠ¤å‘½ä»¤

```bash
# æŸ¥çœ‹å½“å‰ç™»å½•ç”¨æˆ·
who

# æŸ¥çœ‹ç”¨æˆ·æœ€åç™»å½•æ—¶é—´
lastlog

# æŸ¥çœ‹ç”¨æˆ·è´¦æˆ·çŠ¶æ€
sudo passwd -S username

# æŸ¥çœ‹å¤±è´¥ç™»å½•å°è¯•
sudo lastb

# é”å®š/è§£é”ç”¨æˆ·
sudo usermod -L username  # é”å®š
sudo usermod -U username  # è§£é”
```

### å®šæœŸå®‰å…¨æ£€æŸ¥

```bash
# æ£€æŸ¥ sudo æ—¥å¿—
sudo cat /var/log/auth.log | grep sudo

# æ£€æŸ¥ SSH ç™»å½•è®°å½•
sudo cat /var/log/auth.log | grep ssh

# æ£€æŸ¥å¼‚å¸¸ç™»å½•
sudo awk '/Failed password/ { print $1, $2, $3, $9, $11 }' /var/log/auth.log
```

## ğŸ”„ ä¸‹ä¸€æ­¥

ç”¨æˆ·ç¯å¢ƒé…ç½®å®Œæˆåï¼Œè¯·ç»§ç»­è¿›è¡Œï¼š

1. [ğŸŒ ç½‘ç»œç¯å¢ƒé…ç½®](æœåŠ¡å™¨åˆå§‹åŒ–--ç½‘ç»œç¯å¢ƒ.md) - é…ç½®VPNä»£ç†å’Œç½‘ç»œä¼˜åŒ–
2. [ğŸ³ Docker å®‰è£…é…ç½®](æœåŠ¡å™¨åˆå§‹åŒ–--docker.md) - å®‰è£…å’Œé…ç½®Dockerç¯å¢ƒ

---

> ğŸ’¡ **é‡è¦æé†’**: 
> - è¯·å¦¥å–„ä¿ç®¡ SSH ç§é’¥æ–‡ä»¶
> - å®šæœŸè½®æ¢ç”¨æˆ·å¯†ç å’Œ SSH å¯†é’¥
> - ç›‘æ§ç”¨æˆ·ç™»å½•æ—¥å¿—ï¼ŒåŠæ—¶å‘ç°å¼‚å¸¸è®¿é—®