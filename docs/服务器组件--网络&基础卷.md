# 服务器组件 - 网络&基础卷

> 🔧 创建 Docker 网络架构和数据持久化存储卷

## 🎯 基础设施目标

- 创建隔离的 Docker 网络架构
- 建立数据持久化存储卷
- 配置网络安全策略
- 设置服务发现和负载均衡
- 建立监控和日志收集基础

## 🌐 网络架构设计

### 网络拓扑结构

```
                    🌍 External Traffic
                            │
                    ┌───────▼───────┐
                    │  Host Network │
                    │   (物理网卡)   │
                    └───────┬───────┘
                            │
            ┌───────────────┼───────────────┐
            │               │               │
    ┌───────▼───────┐      │      ┌────────▼────────┐
    │ infra-frontend │      │      │  infra-backend  │
    │   (对外服务)   │      │      │   (内部服务)    │
    │                │      │      │                 │
    │  ┌─────────┐   │      │      │  ┌────────────┐ │
    │  │  Nginx  │   │◄─────┼─────►│  │   MySQL    │ │
    │  │ (网关)  │   │      │      │  │   Redis    │ │
    │  └─────────┘   │      │      │  │   MongoDB  │ │
    │                │      │      │  │   Kafka    │ │
    │  ┌─────────┐   │      │      │  │   Jenkins  │ │
    │  │  Apps   │   │      │      │  └────────────┘ │
    │  │ (应用)  │   │      │      │                 │
    │  └─────────┘   │      │      └─────────────────┘
    └───────────────┘      │
            │               │
            └───────────────┼───────────────┐
                            │               │
                    ┌───────▼───────┐      │
                    │  Docker Host  │      │
                    │   网络命名空间  │      │
                    └───────────────┘      │
                                          │
                            ┌─────────────▼──────────────┐
                            │         数据卷层            │
                            │  ┌────────────────────────┐ │
                            │  │    infra_mysql_data    │ │
                            │  │    infra_redis_data    │ │
                            │  │    infra_mongo_data    │ │
                            │  │    infra_kafka_data    │ │
                            │  │   infra_jenkins_data   │ │
                            │  │    infra_nginx_conf    │ │
                            │  └────────────────────────┘ │
                            └────────────────────────────┘
```

### 网络分层策略

| 网络层级 | 网络名称 | 用途 | 访问控制 |
|---------|---------|------|----------|
| **对外服务** | `infra-frontend` | Web服务、API网关 | 公网可访问 |
| **内部服务** | `infra-backend` | 数据库、消息队列 | 仅内网访问 |
| **管理网络** | `infra-mgmt` | 监控、管理界面 | 限制访问 |

## 🚀 自动化部署

### 一键基础设施创建

```bash
# 使用 compose-manager 脚本创建基础设施
./scripts/deploy/compose-manager.sh infra up core

# 自动完成：
# ✅ 创建 Docker 网络 (frontend/backend)
# ✅ 创建数据持久化卷
# ✅ 设置网络安全策略
# ✅ 配置服务发现
# ✅ 验证网络连通性
```

### 验证基础设施

```bash
# 检查网络创建状态
docker network ls | grep infra-

# 检查数据卷创建状态
docker volume ls | grep infra_

# 测试网络连通性
./scripts/deploy/compose-manager.sh infra test network
```

## 🔧 手动配置步骤

### 步骤 1: 创建 Docker 网络

```bash
# 创建前端网络（对外服务）
docker network create \
  --driver bridge \
  --subnet=172.20.0.0/16 \
  --ip-range=172.20.1.0/24 \
  --gateway=172.20.0.1 \
  --opt com.docker.network.bridge.name=infra-frontend \
  --opt com.docker.network.driver.mtu=1500 \
  infra-frontend

# 创建后端网络（内部服务）
docker network create \
  --driver bridge \
  --subnet=172.21.0.0/16 \
  --ip-range=172.21.1.0/24 \
  --gateway=172.21.0.1 \
  --opt com.docker.network.bridge.name=infra-backend \
  --opt com.docker.network.driver.mtu=1500 \
  --internal \
  infra-backend

# 验证网络创建
docker network ls
docker network inspect infra-frontend
docker network inspect infra-backend
```

### 步骤 2: 创建数据持久化卷

```bash
# MySQL 数据卷
docker volume create \
  --driver local \
  --opt type=none \
  --opt o=bind \
  --opt device=/data/infra/mysql/data \
  infra_mysql_data

# Redis 数据卷  
docker volume create \
  --driver local \
  --opt type=none \
  --opt o=bind \
  --opt device=/data/infra/redis/data \
  infra_redis_data

# MongoDB 数据卷
docker volume create \
  --driver local \
  --opt type=none \
  --opt o=bind \
  --opt device=/data/infra/mongo/data \
  infra_mongo_data

# Kafka 数据卷
docker volume create \
  --driver local \
  --opt type=none \
  --opt o=bind \
  --opt device=/data/infra/kafka/data \
  infra_kafka_data

# Jenkins 数据卷
docker volume create \
  --driver local \
  --opt type=none \
  --opt o=bind \
  --opt device=/data/infra/jenkins/data \
  infra_jenkins_data

# Nginx 配置卷
docker volume create \
  --driver local \
  --opt type=none \
  --opt o=bind \
  --opt device=/data/infra/nginx/conf \
  infra_nginx_conf
```

### 步骤 3: 创建数据目录结构

```bash
# 创建基础目录结构
sudo mkdir -p /data/infra/{mysql,redis,mongo,kafka,jenkins,nginx}/{data,conf,logs}

# 设置目录权限
sudo chown -R admin:wheel /data/infra
sudo chmod -R 755 /data/infra

# MySQL 数据目录权限
sudo chown -R 999:999 /data/infra/mysql/data
sudo chmod 750 /data/infra/mysql/data

# Redis 数据目录权限  
sudo chown -R 999:999 /data/infra/redis/data
sudo chmod 750 /data/infra/redis/data

# MongoDB 数据目录权限
sudo chown -R 999:999 /data/infra/mongo/data
sudo chmod 750 /data/infra/mongo/data

# Kafka 数据目录权限
sudo chown -R 1001:1001 /data/infra/kafka/data
sudo chmod 750 /data/infra/kafka/data

# Jenkins 数据目录权限
sudo chown -R 1000:1000 /data/infra/jenkins/data
sudo chmod 750 /data/infra/jenkins/data

# Nginx 配置目录权限
sudo chown -R 101:101 /data/infra/nginx/conf
sudo chmod 750 /data/infra/nginx/conf
```

### 步骤 4: 配置网络安全策略

```bash
# 创建网络安全规则脚本
sudo tee /usr/local/bin/infra-network-security << 'EOF'
#!/bin/bash

# 禁止 frontend 网络访问宿主机敏感端口
iptables -I DOCKER-USER -s 172.20.0.0/16 -d 172.17.0.1 -p tcp --dport 22 -j DROP
iptables -I DOCKER-USER -s 172.20.0.0/16 -d 172.17.0.1 -p tcp --dport 3306 -j DROP

# 允许 frontend 到 backend 的特定连接
iptables -I DOCKER-USER -s 172.20.0.0/16 -d 172.21.0.0/16 -p tcp --dport 3306 -j ACCEPT
iptables -I DOCKER-USER -s 172.20.0.0/16 -d 172.21.0.0/16 -p tcp --dport 6379 -j ACCEPT
iptables -I DOCKER-USER -s 172.20.0.0/16 -d 172.21.0.0/16 -p tcp --dport 27017 -j ACCEPT

# 禁止 backend 网络访问外网（除 DNS）
iptables -I DOCKER-USER -s 172.21.0.0/16 ! -d 172.21.0.0/16 -p tcp --dport 80 -j DROP
iptables -I DOCKER-USER -s 172.21.0.0/16 ! -d 172.21.0.0/16 -p tcp --dport 443 -j DROP
iptables -I DOCKER-USER -s 172.21.0.0/16 ! -d 172.21.0.0/16 -p tcp --dport 53 -j ACCEPT
iptables -I DOCKER-USER -s 172.21.0.0/16 ! -d 172.21.0.0/16 -p udp --dport 53 -j ACCEPT

echo "✅ Docker 网络安全规则已应用"
EOF

sudo chmod +x /usr/local/bin/infra-network-security

# 执行网络安全配置
sudo /usr/local/bin/infra-network-security
```

## 📊 网络管理和监控

### 网络信息查看

```bash
# 查看网络详情
docker network ls --format "table {{.Name}}\t{{.Driver}}\t{{.Scope}}"

# 查看网络配置
docker network inspect infra-frontend --format '{{json .IPAM.Config}}'
docker network inspect infra-backend --format '{{json .IPAM.Config}}'

# 查看连接的容器
docker network inspect infra-frontend --format '{{range $id, $container := .Containers}}{{$container.Name}} {{$container.IPv4Address}}{{"\n"}}{{end}}'
```

### 数据卷管理

```bash
# 查看数据卷列表
docker volume ls --format "table {{.Name}}\t{{.Driver}}\t{{.Scope}}"

# 查看数据卷详情
docker volume inspect infra_mysql_data --format '{{json .Mountpoint}}'

# 检查数据卷使用情况
docker system df -v | grep infra_
```

### 网络测试工具

```bash
# 创建网络测试容器
docker run -it --rm \
  --network infra-frontend \
  --name net-test-frontend \
  nicolaka/netshoot

# 测试网络连通性
docker exec net-test-frontend ping -c 3 172.21.0.1
docker exec net-test-frontend nslookup mysql.infra-backend
docker exec net-test-frontend telnet redis.infra-backend 6379

# 查看网络路由
docker exec net-test-frontend ip route
docker exec net-test-frontend iptables -L
```

## 🔍 Docker Compose 配置

### 基础网络和卷定义

```yaml
# compose/infra/docker-compose.yml
version: '3.8'

networks:
  infra-frontend:
    external: true
    name: infra-frontend
  
  infra-backend:
    external: true  
    name: infra-backend

volumes:
  infra_mysql_data:
    external: true
    name: infra_mysql_data
  
  infra_redis_data:
    external: true
    name: infra_redis_data
    
  infra_mongo_data:
    external: true
    name: infra_mongo_data
    
  infra_kafka_data:
    external: true
    name: infra_kafka_data
    
  infra_jenkins_data:
    external: true
    name: infra_jenkins_data
    
  infra_nginx_conf:
    external: true
    name: infra_nginx_conf
```

### 服务网络配置示例

```yaml
services:
  nginx:
    image: nginx:alpine
    networks:
      - infra-frontend
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - infra_nginx_conf:/etc/nginx

  mysql:
    image: mysql:8.0
    networks:
      - infra-backend
    volumes:
      - infra_mysql_data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
```

## 📋 验证检查清单

### ✅ 网络创建验证

```bash
# 检查网络是否存在
docker network inspect infra-frontend >/dev/null 2>&1 && echo "✅ frontend 网络创建成功" || echo "❌ frontend 网络创建失败"
docker network inspect infra-backend >/dev/null 2>&1 && echo "✅ backend 网络创建成功" || echo "❌ backend 网络创建失败"

# 检查网络配置
docker network inspect infra-frontend | grep -q '"Internal": false' && echo "✅ frontend 网络配置正确" || echo "❌ frontend 网络配置错误"
docker network inspect infra-backend | grep -q '"Internal": true' && echo "✅ backend 网络隔离正确" || echo "❌ backend 网络隔离错误"
```

### ✅ 数据卷验证

```bash
# 检查数据卷创建
for vol in mysql redis mongo kafka jenkins nginx; do
  docker volume inspect infra_${vol}_data >/dev/null 2>&1 && echo "✅ ${vol} 数据卷创建成功" || echo "❌ ${vol} 数据卷创建失败"
done

# 检查目录权限
ls -ld /opt/infra/*/data | while read perm links owner group size month day time dir; do
  [[ $perm == d*750 ]] && echo "✅ $dir 权限正确 ($perm)" || echo "❌ $dir 权限错误 ($perm)"
done
```

### ✅ 网络安全验证

```bash
# 检查防火墙规则
sudo iptables -L DOCKER-USER | grep -q "172.20.0.0/16" && echo "✅ 网络安全规则已应用" || echo "❌ 网络安全规则未应用"

# 测试网络隔离
docker run --rm --network infra-backend nicolaka/netshoot ping -c 1 -W 1 8.8.8.8 >/dev/null 2>&1 && echo "❌ backend 网络隔离失败" || echo "✅ backend 网络隔离成功"
```

## 🚨 故障排除

### 网络连接问题

```bash
# 问题 1: 容器无法连接到网络
# 查看网络驱动状态
docker network ls
sudo systemctl status docker

# 重新创建网络
docker network rm infra-frontend infra-backend
# 重新执行网络创建步骤

# 问题 2: 网络 IP 冲突
# 查看现有网络 IP 分配
docker network ls --format "table {{.Name}}\t{{.Driver}}"
docker network inspect $(docker network ls -q) | grep Subnet

# 修改网络 IP 段
# 编辑网络配置，使用不同的 IP 段
```

### 数据卷问题

```bash
# 问题 3: 数据卷挂载失败
# 检查目录存在和权限
ls -ld /opt/infra/*/data
sudo chown -R admin:wheel /opt/infra

# 检查数据卷状态
docker volume inspect infra_mysql_data
docker volume ls --filter dangling=true

# 重新创建数据卷
docker volume rm infra_mysql_data
# 重新执行数据卷创建步骤
```

### 权限问题

```bash
# 问题 4: 容器启动权限错误
# 查看容器日志
docker logs container_name

# 修复目录权限
sudo chown -R 999:999 /opt/infra/mysql/data
sudo chown -R 1001:1001 /opt/infra/kafka/data
sudo chown -R 1000:1000 /opt/infra/jenkins/data

# 检查 SELinux（如果启用）
getenforce
sudo setsebool -P container_manage_cgroup on
```

## 🔧 高级配置

### 网络性能优化

```bash
# 优化网络 MTU
docker network create \
  --opt com.docker.network.driver.mtu=9000 \
  --subnet=172.22.0.0/16 \
  infra-jumbo

# 启用网络加速
echo 'net.core.default_qdisc = fq_codel' | sudo tee -a /etc/sysctl.conf
echo 'net.ipv4.tcp_congestion_control = bbr' | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

### 数据卷备份策略

```bash
# 创建数据备份脚本
sudo tee /usr/local/bin/infra-backup << 'EOF'
#!/bin/bash
BACKUP_DIR="/opt/backups/infra/$(date +%Y%m%d)"
mkdir -p $BACKUP_DIR

# 备份 MySQL
docker exec mysql mysqldump --all-databases --routines --triggers > $BACKUP_DIR/mysql-backup.sql

# 备份 Redis
docker exec redis redis-cli BGSAVE
docker cp redis:/data/dump.rdb $BACKUP_DIR/

# 备份 MongoDB
docker exec mongo mongodump --out $BACKUP_DIR/mongo-backup

# 备份配置文件
tar -czf $BACKUP_DIR/configs.tar.gz /opt/infra/*/conf

echo "✅ 备份完成: $BACKUP_DIR"
EOF

sudo chmod +x /usr/local/bin/infra-backup

# 设置定时备份
echo "0 2 * * * /usr/local/bin/infra-backup" | sudo crontab -
```

### 网络监控

```bash
# 安装网络监控工具
docker run -d \
  --name network-monitor \
  --network infra-frontend \
  --restart unless-stopped \
  -v /proc:/host/proc:ro \
  -v /sys:/host/sys:ro \
  prom/node-exporter \
    --path.procfs=/host/proc \
    --path.sysfs=/host/sys \
    --collector.filesystem.ignored-mount-points \
    "^/(sys|proc|dev|host|etc|rootfs/var/lib/docker/containers|rootfs/var/lib/docker/overlay2|rootfs/run/docker/netns|rootfs/var/lib/docker/aufs)($$|/)"
```

## 🔄 下一步

网络和基础卷配置完成后，请按推荐顺序部署服务：

1. [🗄️ 存储服务](服务器组件--存储服务(MySQL_Redis_MongoDB).md) - 部署 MySQL/Redis/MongoDB
2. [📨 消息服务](服务器组件--消息服务(Kafka).md) - 部署 Kafka 消息队列
3. [🔧 CI/CD服务](服务器组件--CI_CD(Jenkins).md) - 部署 Jenkins 平台
4. [🌐 网关服务](服务器组件--网关(Nginx).md) - 部署 Nginx 网关

---

> 💡 **网络架构提醒**:
> - 定期检查网络安全规则的有效性
> - 监控数据卷的磁盘使用情况
> - 备份重要数据卷和网络配置
> - 保持网络拓扑文档的更新
> - 定期测试网络隔离和连通性